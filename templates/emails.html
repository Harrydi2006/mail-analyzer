{% extends "base.html" %}

{% block title %}é‚®ä»¶ç®¡ç† - é‚®ä»¶æ™ºèƒ½æ—¥ç¨‹ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-inbox me-2"></i>
                é‚®ä»¶ç®¡ç†
            </h2>
            <div>
                <div class="btn-group me-2" role="group">
                    <button class="btn btn-primary" onclick="fetchEmailsStream()">
                        <i class="fas fa-stream me-1"></i>
                        æµå¼å¤„ç†é‚®ä»¶
                    </button>
                    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                        <span class="visually-hidden">åˆ‡æ¢ä¸‹æ‹‰èœå•</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="if(window.checkEmail){window.checkEmail()}"><i class="fas fa-sync-alt me-2"></i>ä¼ ç»Ÿæ£€æŸ¥é‚®ä»¶</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="reanalyzeAllEmails()"><i class="fas fa-robot me-2"></i>é‡æ–°åˆ†ææ‰€æœ‰é‚®ä»¶</a></li>
                        <li><a class="dropdown-item" href="#" onclick="reanalyzeFailedEmails()"><i class="fas fa-bug me-2"></i>é‡æ–°åˆ†æå¤±è´¥é‚®ä»¶</a></li>
                    </ul>
                </div>
                <!-- ä»…åŒæ­¥å‰Nå°è®¾ç½® -->
                <div class="input-group me-2" style="width: 240px;">
                    <span class="input-group-text">å‰Nå°</span>
                    <input type="number" min="1" class="form-control" id="max-sync-count" placeholder="é»˜è®¤å…¨éƒ¨">
                </div>
                <button class="btn btn-outline-secondary" onclick="refreshEmails()">
                    <i class="fas fa-refresh me-1"></i>
                    åˆ·æ–°åˆ—è¡¨
                </button>
            </div>
        </div>

                <!-- æ£€æŸ¥é‚®ä»¶è¿›åº¦æ¡ -->
                <div id="check-progress" class="d-none mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-spinner fa-spin me-2 text-primary"></i>
                        <strong>æ­£åœ¨æ£€æŸ¥æ–°é‚®ä»¶...</strong>
                        <small class="ms-2 text-muted" id="check-progress-text"></small>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="check-progress-bar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
        
        <!-- ç­›é€‰å’Œæœç´¢ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">é‡è¦æ€§ç­›é€‰</label>
                        <select class="form-select" id="importance-filter">
                            <option value="">å…¨éƒ¨</option>
                            <option value="important">é‡è¦</option>
                            <option value="normal">æ™®é€š</option>
                            <option value="unimportant">ä¸é‡è¦</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">å¤„ç†çŠ¶æ€</label>
                        <select class="form-select" id="status-filter">
                            <option value="">å…¨éƒ¨</option>
                            <option value="processed">å·²å¤„ç†</option>
                            <option value="unprocessed">æœªå¤„ç†</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">æ˜¾ç¤ºæ•°é‡</label>
                        <select class="form-select" id="limit-select" onchange="changeLimit()">
                            <option value="50">50å°</option>
                            <option value="100">100å°</option>
                            <option value="200" selected>200å°</option>
                            <option value="500">500å°</option>
                            <option value="1000">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">æœç´¢</label>
                        <input type="text" class="form-control" id="search-input" placeholder="æœç´¢é‚®ä»¶ä¸»é¢˜æˆ–å‘ä»¶äºº...">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-primary d-block w-100" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>
                            æœç´¢
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-info" onclick="syncAllToNotion()">
                                <i class="fas fa-sync me-1"></i>
                                ä¸€é”®åŒæ­¥åˆ°Notion
                            </button>
                            <button class="btn btn-outline-info" onclick="syncSelectedToNotion()">
                                <i class="fas fa-check-square me-1"></i>
                                åŒæ­¥é€‰ä¸­é‚®ä»¶
                            </button>
                            <div class="ms-auto">
                                <small class="text-muted">å·²é€‰ä¸­ <span id="selected-count">0</span> å°é‚®ä»¶</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é‚®ä»¶åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">é‚®ä»¶åˆ—è¡¨</h5>
                    <span class="badge bg-secondary" id="email-count">0 å°é‚®ä»¶</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="emails-container">
                    <div class="text-center p-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">åŠ è½½é‚®ä»¶åˆ—è¡¨ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åˆ†é¡µ -->
        <nav aria-label="é‚®ä»¶åˆ†é¡µ" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </nav>
    </div>
</div>

<!-- é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailModalTitle">é‚®ä»¶è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="emailModalBody">
                <!-- é‚®ä»¶è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" id="viewNotionBtn" style="display: none;">
                    <i class="fas fa-external-link-alt me-1"></i>
                    æŸ¥çœ‹Notioné¡µé¢
                </button>
                <button type="button" class="btn btn-info" id="archiveNotionBtn" style="display: none;">
                    <i class="fas fa-archive me-1"></i>
                    å½’æ¡£åˆ°Notion
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">å›¾ç‰‡æŸ¥çœ‹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imageModalImg" src="" alt="" class="img-fluid" style="max-height: 70vh;">
            </div>
            <div class="modal-footer">
                <a id="imageDownloadBtn" href="" class="btn btn-primary" download="">
                    <i class="fas fa-download me-1"></i>ä¸‹è½½å›¾ç‰‡
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};
let streamingInProgress = false; // è·Ÿè¸ªæµå¼å¤„ç†çŠ¶æ€
let currentEventSource = null;

$(document).ready(function() {
    // ä»URLå‚æ•°è®¾ç½®æ˜¾ç¤ºæ•°é‡
    const urlParams = new URLSearchParams(window.location.search);
    const limit = urlParams.get('limit') || '200';
    $('#limit-select').val(limit);
    
    // ä¼˜å…ˆä»æœåŠ¡ç«¯æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„æµå¼ä»»åŠ¡ï¼ˆæ”¯æŒåˆ·æ–°/é‡æ–°ç™»å½•åæ¢å¤ï¼‰
    initEmailsPage();
    
    // æœç´¢æ¡†å›è½¦äº‹ä»¶
    $('#search-input').on('keypress', function(e) {
        if (e.which === 13) {
            applyFilters();
        }
    });
});

async function initEmailsPage() {
    try {
        const resp = await fetch('/api/emails/stream-status', { credentials: 'same-origin' });
        const data = await resp.json();
        if (data && data.success && data.status && data.status.running) {
            console.log('æ£€æµ‹åˆ°åå°æµå¼ä»»åŠ¡æ­£åœ¨è¿›è¡Œï¼Œæ¢å¤å®æ—¶æ˜¾ç¤º');
                streamingInProgress = true;
            // æ¢å¤ UI å¹¶è®¢é˜…ï¼ˆä¸ startï¼‰
            const maxCount = data.status.params?.max_count || null;
            fetchEmailsStream(false, maxCount);
        } else {
    streamingInProgress = false;
            loadEmails();
        }
    } catch (e) {
        console.warn('è·å–æµå¼çŠ¶æ€å¤±è´¥ï¼Œå›é€€åˆ°åŠ è½½é‚®ä»¶åˆ—è¡¨:', e);
        streamingInProgress = false;
        loadEmails();
    }
}

function loadEmails(page = 1) {
    currentPage = page;
    // è‹¥æ­£åœ¨æµå¼å¤„ç†ï¼Œé¿å…è¦†ç›–æ­£åœ¨å®æ—¶åˆ·æ–°çš„åˆ—è¡¨
    if (streamingInProgress) return;
    
    // è·å–å½“å‰é€‰æ‹©çš„æ˜¾ç¤ºæ•°é‡
    const limit = $('#limit-select').val() || '200';
    
    const params = {
        page: page,
        limit: limit,
        ...currentFilters
    };
    
    $('#emails-container').html(`
        <div class="text-center p-4">
            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="text-muted mt-2">åŠ è½½é‚®ä»¶åˆ—è¡¨ä¸­...</p>
        </div>
    `);
    
    $.get('/api/emails', params, function(data) {
        console.log('é‚®ä»¶APIå“åº”:', data); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        if (data.success) {
            displayEmails(data.emails);
            updatePagination(data.total, data.page, data.per_page);
            $('#email-count').text(`${data.total} å°é‚®ä»¶`);
        } else {
            console.error('é‚®ä»¶APIè¿”å›é”™è¯¯:', data.error); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            $('#emails-container').html(`
                <div class="text-center p-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    <p class="text-muted mt-2">åŠ è½½å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                </div>
            `);
        }
    }).fail(function(xhr, status, error) {
        console.error('é‚®ä»¶APIè¯·æ±‚å¤±è´¥:', status, error, xhr.responseText); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        $('#emails-container').html(`
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                <p class="text-muted mt-2">ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error}</p>
            </div>
        `);
    });
}

function displayEmails(emails) {
    if (emails.length === 0) {
        $('#emails-container').html(`
            <div class="text-center p-4">
                <i class="fas fa-inbox fa-2x text-muted"></i>
                <p class="text-muted mt-2">æš‚æ— é‚®ä»¶æ•°æ®</p>
            </div>
        `);
        return;
    }
    
    // HTML è½¬ä¹‰ï¼ˆæ–‡æœ¬èŠ‚ç‚¹/å±æ€§å€¼éƒ½å¯ç”¨ï¼‰ï¼Œé¿å…é‚®ä»¶ä¸»é¢˜/å‘ä»¶äººåŒ…å«å¼•å·/å°–æ‹¬å·å¯¼è‡´ DOM ç»“æ„ç ´åæˆ– XSS
    function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"']/g, function(ch) {
            switch (ch) {
                case '&': return '&amp;';
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '"': return '&quot;';
                case "'": return '&#39;';
                default: return ch;
            }
        });
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    emails.forEach(function(email) {
        const importanceClass = getImportanceClass(email.importance_level);
        const importanceText = getImportanceText(email.importance_level);
        const receivedDate = new Date(email.received_date).toLocaleString();
        const processedStatus = email.is_processed ? 'å·²å¤„ç†' : 'æœªå¤„ç†';
        const processedClass = email.is_processed ? 'success' : 'warning';
        const eventsCount = email.events ? email.events.length : 0;

        const safeId = escapeHtml(email.id);
        const safeReceivedRaw = escapeHtml(email.received_date);
        const safeSender = escapeHtml(email.sender || '');
        const safeSubject = escapeHtml(email.subject || 'æ— ä¸»é¢˜');
        const safeSummary = escapeHtml(email.summary || 'æš‚æ— AIæ€»ç»“');
        const safeImportance = escapeHtml(email.importance_level);
        
        html += `
            <div class="list-group-item list-group-item-action"
                 id="email-${safeId}"
                 data-email-id="${safeId}"
                 data-received-date="${safeReceivedRaw}"
                 data-sender="${safeSender}"
                 data-subject="${safeSubject}"
                 data-importance-level="${safeImportance}">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="form-check me-3">
                        <input class="form-check-input email-checkbox" type="checkbox" value="${safeId}" onchange="updateSelectedCount()">
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge ${importanceClass} me-2">${importanceText}</span>
                            <span class="badge bg-${processedClass} me-2">${processedStatus}</span>
                            ${eventsCount > 0 ? `<span class="badge bg-info me-2">${eventsCount} ä¸ªäº‹ä»¶</span>` : ''}
                        </div>
                        <h6 class="mb-1">${safeSubject}</h6>
                        <p class="mb-1 text-muted">${safeSummary}</p>
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>${safeSender}
                            <i class="fas fa-clock ms-3 me-1"></i>${receivedDate}
                        </small>
                    </div>
                    <div class="text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewEmail(${safeId})">
                                <i class="fas fa-eye me-1"></i>æŸ¥çœ‹
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="reanalyzeEmail(${safeId})" title="é‡æ–°åˆ†æ">
                                <i class="fas fa-robot"></i>
                            </button>
                            ${(!email.summary || email.summary === 'é‚®ä»¶å†…å®¹åˆ†æå¤±è´¥' || email.summary === 'AIåˆ†æå¤±è´¥') && email.importance_level >= 7 ? 
                                `<button class="btn btn-sm btn-warning" onclick="retryAnalysis(${safeId})" title="åˆ†æå¤±è´¥ï¼Œç‚¹å‡»é‡è¯•">
                                    <i class="fas fa-redo me-1"></i>é‡è¯•
                                </button>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    $('#emails-container').html(html);
}

function viewEmail(emailId) {
    $('#emailModalBody').html(`
        <div class="text-center p-4">
            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="text-muted mt-2">åŠ è½½é‚®ä»¶è¯¦æƒ…ä¸­...</p>
        </div>
    `);
    
    $('#emailModal').modal('show');
    
    $.get(`/api/email/${emailId}`, function(data) {
        if (data.id) {
            displayEmailDetails(data);
        } else {
            $('#emailModalBody').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || 'é‚®ä»¶ä¸å­˜åœ¨'}
                </div>
            `);
        }
    }).fail(function() {
        $('#emailModalBody').html(`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ç½‘ç»œè¯·æ±‚å¤±è´¥
            </div>
        `);
    });
}

function displayEmailDetails(email) {
    const importanceClass = getImportanceClass(email.importance_level);
    const importanceText = getImportanceText(email.importance_level);
    const receivedDate = new Date(email.received_date).toLocaleString();
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>å‘ä»¶äºº:</strong> ${email.sender}
            </div>
            <div class="col-md-6">
                <strong>æ”¶ä»¶æ—¶é—´:</strong> ${receivedDate}
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>é‡è¦æ€§:</strong> 
                <span class="badge ${importanceClass}">${importanceText}</span>
            </div>
            <div class="col-md-6">
                <strong>å¤„ç†çŠ¶æ€:</strong> 
                <span class="badge ${email.is_processed ? 'bg-success' : 'bg-warning'}">
                    ${email.is_processed ? 'å·²å¤„ç†' : 'æœªå¤„ç†'}
                </span>
            </div>
        </div>
    `;
    
    // AIåˆ†æç»“æœ
    if (email.summary) {
        html += `
            <div class="mb-3">
                <h6><i class="fas fa-robot me-2"></i>AIæ€»ç»“</h6>
                <div class="alert alert-info ai-summary">
                    ${email.summary}
                </div>
            </div>
        `;
    }
    
    // æå–çš„äº‹ä»¶
    if (email.events && email.events.length > 0) {
        html += `
            <div class="mb-3">
                <h6><i class="fas fa-calendar-alt me-2"></i>æå–çš„äº‹ä»¶ (${email.events.length})</h6>
        `;
        
        email.events.forEach(function(event, index) {
            const eventImportanceClass = getImportanceClass(event.importance_level);
            const startTime = new Date(event.start_time).toLocaleString();
            
            html += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    <span class="badge ${eventImportanceClass} me-2">${getImportanceText(event.importance_level)}</span>
                                    ${event.title}
                                </h6>
                                <p class="mb-1 small text-dark">${event.description || 'æ— æè¿°'}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>${startTime}
                                    ${event.location ? `<i class="fas fa-map-marker-alt ms-2 me-1"></i>${event.location}` : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // é‚®ä»¶é™„ä»¶å’Œå›¾ç‰‡
    if (email.images && Array.isArray(email.images) && email.images.length > 0) {
        html += `
            <div class="mb-3">
                <h6><i class="fas fa-image me-2"></i>é‚®ä»¶å›¾ç‰‡ (${email.images.length})</h6>
                <div class="row">
        `;
        
        email.images.forEach(function(image, index) {
            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <img src="/attachments/${image.unique_filename}" class="card-img-top" alt="${image.filename}" style="height: 200px; object-fit: cover; cursor: pointer;" onclick="showImageModal('${image.unique_filename}', '${image.filename}')">
                        <div class="card-body p-2">
                            <small class="text-muted">
                                <i class="fas fa-file-image me-1"></i>${image.filename}
                                <br><i class="fas fa-weight me-1"></i>${formatFileSize(image.size || 0)}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // å…¶ä»–é™„ä»¶
    if (email.attachments && Array.isArray(email.attachments) && email.attachments.length > 0) {
        html += `
            <div class="mb-3">
                <h6><i class="fas fa-paperclip me-2"></i>é™„ä»¶ (${email.attachments.length})</h6>
        `;
        
        email.attachments.forEach(function(attachment, index) {
            html += `
                <div class="d-flex align-items-center mb-2 p-2 border rounded">
                    <i class="fas fa-file me-2 text-muted"></i>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${attachment.filename}</div>
                        <small class="text-muted">${formatFileSize(attachment.size || 0)}</small>
                    </div>
                    <a href="/attachments/${attachment.unique_filename}" class="btn btn-sm btn-outline-primary" download="${attachment.filename}">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // é‚®ä»¶åŸæ–‡ï¼ˆå¯Œæ–‡æœ¬ä¼˜å…ˆæ˜¾ç¤ºHTMLï¼Œå¦åˆ™æ˜¾ç¤ºçº¯æ–‡æœ¬ï¼‰
    html += `
        <div class="mb-3">
            <h6><i class="fas fa-envelope me-2"></i>é‚®ä»¶åŸæ–‡</h6>
            ${email.html ? 
                `<div class=\"border rounded p-3 email-content-area\" style=\"max-height: 400px; overflow-y: auto;\">${email.html}</div>` :
                `<div class=\"border rounded p-3 email-content-area\" style=\"max-height: 300px; overflow-y: auto;\"><pre class=\"mb-0 email-content-text\" style=\"white-space: pre-wrap; font-size: 0.9em;\">${email.content || 'æ— å†…å®¹'}</pre></div>`
            }
        </div>
    `;
    
    $('#emailModalTitle').text(email.subject || 'æ— ä¸»é¢˜');
    $('#emailModalBody').html(html);
    
    // è®¾ç½®NotionæŒ‰é’®
    if (email.notion_url) {
        // å¦‚æœå·²ç»å½’æ¡£åˆ°Notionï¼Œæ˜¾ç¤ºæŸ¥çœ‹æŒ‰é’®
        $('#viewNotionBtn').show().off('click').on('click', function() {
            window.open(email.notion_url, '_blank');
        });
        $('#archiveNotionBtn').hide();
    } else {
        // å¦‚æœæœªå½’æ¡£ï¼Œæ˜¾ç¤ºå½’æ¡£æŒ‰é’®
        $('#viewNotionBtn').hide();
        $('#archiveNotionBtn').show().off('click').on('click', function() {
            archiveEmailToNotion(email.id);
        });
 
    }
}

function archiveEmailToNotion(emailId) {
    if (!confirm('ç¡®å®šè¦å°†æ­¤é‚®ä»¶å½’æ¡£åˆ°Notionå—ï¼Ÿ')) {
        return;
    }
    
    showMessage('æ­£åœ¨å½’æ¡£åˆ°Notion...', 'info');
    
    $.ajax({
        url: `/api/notion/archive/${emailId}`,
        method: 'POST',
        success: function(data) {
            if (data.success) {
                showMessage('é‚®ä»¶å½’æ¡£æˆåŠŸï¼', 'success');
                // åˆ·æ–°é‚®ä»¶è¯¦æƒ…
                viewEmail(emailId);
            } else {
                showMessage('å½’æ¡£å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        },
        error: function(xhr, status, error) {
            showMessage('å½’æ¡£è¯·æ±‚å¤±è´¥: ' + error, 'danger');
        }
    });
}
 
 function applyFilters() {
    currentFilters = {
        importance: $('#importance-filter').val(),
        status: $('#status-filter').val(),
        search: $('#search-input').val().trim()
    };
    
    loadEmails(1);
}

function refreshEmails() {
    loadEmails(currentPage);
}

function updatePagination(total, page, perPage) {
    totalPages = Math.ceil(total / perPage);
    currentPage = page;
    
    let html = '';
    
    // ä¸Šä¸€é¡µ
    if (currentPage > 1) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadEmails(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
    }
    
    // é¡µç 
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadEmails(1)">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadEmails(${i})">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadEmails(${totalPages})">${totalPages}</a></li>`;
    }
    
    // ä¸‹ä¸€é¡µ
    if (currentPage < totalPages) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadEmails(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
    }
    
    $('#pagination').html(html);
}

function getImportanceClass(level) {
    switch(level) {
        case 'important': return 'bg-danger';
        case 'normal': return 'bg-primary';
        case 'unimportant': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

function getImportanceText(level) {
    switch(level) {
        case 'important': return 'é‡è¦';
        case 'normal': return 'æ™®é€š';
        case 'unimportant': return 'ä¸é‡è¦';
        default: return 'æœªçŸ¥';
    }
}

function changeLimit() {
    const limit = $('#limit-select').val();
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('limit', limit);
    window.location.href = currentUrl.toString();
}

function checkEmail() {
    // æ˜¾ç¤ºè¿›åº¦æ¡
    $('#check-progress').removeClass('d-none');
    $('#check-progress-text').text('æ­£åœ¨æ£€æŸ¥æ–°é‚®ä»¶...');
    $('#check-progress-bar').css('width', '10%');
    
    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
    let progress = 10;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15; // éšæœºå¢åŠ è¿›åº¦
        if (progress > 90) progress = 90; // æœ€å¤šåˆ°90%
        $('#check-progress-bar').css('width', progress + '%');
        $('#check-progress-text').text(`æ­£åœ¨å¤„ç†é‚®ä»¶... ${Math.round(progress)}%`);
    }, 500);
    
    $.ajax({
        url: '/api/check_email',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ max_count: getMaxSyncCount() }),
        success: function(data) {
            clearInterval(progressInterval);
            if (data.success) {
                $('#check-progress-bar').css('width', '100%');
                $('#check-progress-text').text('æ£€æŸ¥å®Œæˆ');
                showMessage(data.message, 'success');
                setTimeout(() => {
                    $('#check-progress').addClass('d-none');
                    refreshEmails(); // åˆ·æ–°é‚®ä»¶åˆ—è¡¨
                }, 1000);
            } else {
                $('#check-progress').addClass('d-none');
                showMessage('æ£€æŸ¥é‚®ä»¶å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        },
        error: function(xhr, status, error) {
            clearInterval(progressInterval);
            $('#check-progress').addClass('d-none');
            showMessage('æ£€æŸ¥é‚®ä»¶è¯·æ±‚å¤±è´¥: ' + error, 'danger');
        }
    });
}

// æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°å»ºç«‹æµå¼å¤„ç†
function checkAndRestartStreaming() {
    // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æµå¼å¤„ç†
    const streamingProgress = $('#streaming-progress');
    if (streamingProgress.length > 0) {
        // å¦‚æœæœ‰æµå¼å¤„ç†è¿›åº¦æ¡ï¼Œæ£€æŸ¥æ˜¯å¦çœŸçš„è¢«ä¸­æ–­äº†
        const logContainer = $('#streaming-log');
        if (logContainer.length > 0) {
            // æ£€æŸ¥æœ€åä¸€æ¡æ—¥å¿—æ˜¯å¦è¡¨ç¤ºå¤„ç†å®Œæˆ
            const lastLog = logContainer.find('div').last().text();
            if (!lastLog.includes('å®Œæˆ') && !lastLog.includes('é”™è¯¯') && !lastLog.includes('å¤±è´¥')) {
                // å¦‚æœæœ€åä¸€æ¡æ—¥å¿—ä¸æ˜¯å®ŒæˆçŠ¶æ€ï¼Œè¯´æ˜å¯èƒ½è¢«ä¸­æ–­äº†
                logContainer.append(`<div class="text-warning">ğŸ”„ æ£€æµ‹åˆ°é¡µé¢åˆ·æ–°ï¼Œé‡æ–°å»ºç«‹æµå¼å¤„ç†...</div>`);
                // å»¶è¿Ÿé‡æ–°å¼€å§‹æµå¼å¤„ç†
                setTimeout(() => {
                    fetchEmailsStream();
                }, 1000);
            }
        }
    }
}

// é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥
$(document).ready(function() {
    // ç§»é™¤è‡ªåŠ¨é‡å¯åŠŸèƒ½ï¼Œé¿å…å¹²æ‰°æ­£å¸¸çš„æµå¼å¤„ç†
    // setTimeout(checkAndRestartStreaming, 2000);
});

// æµå¼è·å–é‚®ä»¶
// start=trueï¼šå¯åŠ¨åå°ä»»åŠ¡å¹¶è®¢é˜…ï¼›start=falseï¼šä»…è®¢é˜…ï¼ˆç”¨äºåˆ·æ–°/é‡æ–°ç™»å½•æ¢å¤ï¼‰
function fetchEmailsStream(start = true, presetMaxCount = null) {
    const maxCount = (presetMaxCount !== null && presetMaxCount !== undefined) ? presetMaxCount : getMaxSyncCount();
    
    // è®¾ç½®æµå¼å¤„ç†çŠ¶æ€
    streamingInProgress = true;
    
    // åˆ›å»ºè¿›åº¦æ˜¾ç¤ºåŒºåŸŸ
    const progressHtml = `
        <div id="streaming-progress" class="mt-3 mb-4">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-stream me-2"></i>é‚®ä»¶æµå¼å¤„ç†è¿›åº¦
                        <span class="badge bg-light text-primary ms-2" id="streaming-stats">å¤„ç†ä¸­...</span>
                    </h6>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-light" onclick="stopEmailsStream()" title="ç»ˆæ­¢æµå¼å¤„ç†">
                            <i class="fas fa-stop me-1"></i>ç»ˆæ­¢
                        </button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="toggleStreamingLog()" title="å±•å¼€/æŠ˜å æ—¥å¿—">
                        <i class="fas fa-expand-alt" id="streaming-toggle-icon"></i>
                    </button>
                    </div>
                </div>
                <div class="card-body p-2" id="streaming-log-container">
                    <div id="streaming-log" style="max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85em; background-color: #f8f9fa; padding: 10px; border-radius: 4px; scroll-behavior: smooth;">
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // å¦‚æœå·²å­˜åœ¨è¿›åº¦åŒºåŸŸï¼Œå…ˆç§»é™¤
    $('#streaming-progress').remove();
    // æ’å…¥åˆ°é¡µé¢æ ‡é¢˜åé¢ï¼Œç­›é€‰å¡ç‰‡å‰é¢
    $('h2').parent().after(progressHtml);
    
    const logContainer = $('#streaming-log');
    let processedCount = 0;
    let savedCount = 0;
    let analyzedCount = 0;
    let savedEmails = []; // å­˜å‚¨å·²ä¿å­˜çš„é‚®ä»¶
    let existingEmails = []; // å­˜å‚¨å·²å­˜åœ¨çš„é‚®ä»¶
    
    // å¼€å§‹æµå¼å¤„ç†
    logContainer.append(`<div class="text-primary">ğŸš€ å¼€å§‹æµå¼å¤„ç†é‚®ä»¶...</div>`);
    
    // è·å–å½“å‰é¡µé¢çš„ç°æœ‰é‚®ä»¶ï¼ˆä» data-* è¯»ï¼Œé¿å…è§£æ DOM æ–‡æœ¬å¯¼è‡´é”™ä½ï¼‰
    function getExistingEmails() {
        const existingEmails = [];
        $('#emails-container .list-group-item').each(function() {
            const $item = $(this);
            const emailId = parseInt($item.data('email-id') || ($item.attr('id') || '').replace('email-', ''), 10);
            const subject = ($item.data('subject') || $item.find('h6').text() || '').toString().trim();
            const sender = ($item.data('sender') || '').toString().trim() || ($item.find('small.text-muted').text() || '').toString().trim();
            const receivedDate = ($item.data('received-date') || '').toString().trim() || new Date().toISOString();
            const importanceLevel = ($item.data('importance-level') || 'normal').toString();
            const summary = ($item.find('p.text-muted').first().text() || '').toString().trim();
            const isProcessed = $item.find('.badge').eq(1).text().trim() === 'å·²å¤„ç†';
            
            // æå–äº‹ä»¶æ•°é‡
            const eventsBadge = $(this).find('.badge.bg-info').text().trim();
            const eventsMatch = eventsBadge.match(/(\d+)/);
            const eventsCount = eventsMatch ? parseInt(eventsMatch[1]) : 0;
            
            existingEmails.push({
                id: parseInt(emailId),
                subject: subject,
                sender: sender,
                received_date: receivedDate,
                importance_level: importanceLevel,
                summary: summary,
                is_processed: isProcessed,
                events: eventsCount > 0 ? Array(eventsCount).fill({}) : []
            });
        });
        return existingEmails;
    }
    
    // è·å–ç°æœ‰é‚®ä»¶
    // ä¸ºäº†ä¿è¯â€œæ–°é‚®ä»¶ä¸€å®šå‡ºç°åœ¨æœ€å‰é¢â€ï¼Œæµå¼å¤„ç†ä¸€å¾‹ä»¥â€œç¬¬ä¸€é¡µï¼ˆæœ€æ–°ï¼‰â€ä½œä¸ºåŸºå‡†åˆ—è¡¨
    function loadBaselineAndStart() {
        const baselineParams = { page: 1, per_page: 50, ...(currentFilters || {}) };
        logContainer.append(`<div class="text-muted">ğŸ“¥ åŠ è½½æœ€æ–°é‚®ä»¶é¡µä½œä¸ºåŸºå‡†åˆ—è¡¨...</div>`);
        $.get('/api/emails', baselineParams, function(resp) {
            if (resp && resp.success && Array.isArray(resp.emails)) {
                existingEmails = resp.emails.map(e => ({
                    id: e.id,
                    subject: e.subject,
                    sender: e.sender,
                    received_date: e.received_date,
                    importance_level: e.importance_level || 'normal',
                    summary: e.summary || '',
                    is_processed: !!e.is_processed,
                    events: e.events || []
                }));
                displayEmails(existingEmails);
            } else {
    existingEmails = getExistingEmails();
            }
            startEventSource();
        }).fail(function() {
            existingEmails = getExistingEmails();
            startEventSource();
        });
    }
    
    function startEventSource() {
    // ä½¿ç”¨EventSourceè¿›è¡ŒçœŸæ­£çš„æµå¼å¤„ç†
    const params = {
            days_back: 1,
            // å¹¶è¡Œåˆ†æçš„çº¿ç¨‹æ•°ï¼ˆé»˜è®¤ 3ï¼›å¦‚éœ€æ›´å¤§å¯åœ¨æ­¤è°ƒæ•´æˆ–åç»­åšæˆå¯é…ç½® UIï¼‰
            analysis_workers: 3
    };
    if (maxCount && maxCount > 0) {
        params.max_count = maxCount;
    }
        if (start) {
            params.start = 1;
        }
    const streamUrl = '/api/emails/fetch-stream?' + new URLSearchParams(params).toString();
    
    console.log('å¼€å§‹EventSourceè¿æ¥:', streamUrl); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        // å¦‚æœå·²æœ‰è¿æ¥ï¼Œå…ˆå…³é—­
        try { if (currentEventSource) currentEventSource.close(); } catch (_) {}
    const eventSource = new EventSource(streamUrl);
        currentEventSource = eventSource;
    
    eventSource.onopen = function(event) {
        console.log('EventSourceè¿æ¥å·²æ‰“å¼€'); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        logContainer.append(`<div class="text-success">ğŸ”— æµå¼è¿æ¥å·²å»ºç«‹</div>`);
    };
    
    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            // æ§åˆ¶å°è¾“å‡ºæ”¹ä¸ºæ›´ç²¾ç®€ï¼Œé¿å…ä¸€å°é‚®ä»¶å¤šé˜¶æ®µäº‹ä»¶çœ‹èµ·æ¥åƒâ€œé‡å¤ä¸‰æ¬¡â€
            console.debug('[stream]', data.status, data.email_id || '', data._seq || '');
            // keepalive ä¸å†™æ—¥å¿—ï¼Œé¿å…åˆ·å±
            if (data.status === 'keepalive') {
                return;
            }
            
            if (data.status === 'started') {
                logContainer.append(`<div class="text-info">ğŸ“§ ${data.message}</div>`);
            } else if (data.status === 'stats') {
                logContainer.append(`<div class="text-primary fw-bold">ğŸ“Š ${data.message}</div>`);
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStreamingStats(0, data.total_emails, 0, 0);
            } else if (data.status === 'saving') {
                logContainer.append(`<div class="text-warning">ğŸ’¾ ${data.message}</div>`);
            } else if (data.status === 'saved') {
                savedCount++;
                savedEmails.push({
                    id: data.email_id,
                    subject: data.subject,
                    sender: data.sender,
                    received_date: data.received_date || new Date().toISOString(),
                    importance_level: 'normal', // é»˜è®¤é‡è¦æ€§ï¼Œç­‰å¾…AIåˆ†æ
                    summary: 'æ­£åœ¨åˆ†æä¸­...',
                    is_processed: false,
                    events: []
                });
                
                logContainer.append(`<div class="text-success">âœ… ${data.message}</div>`);
                
                // å®æ—¶æ›´æ–°é‚®ä»¶åˆ—è¡¨
                updateEmailList();
                
            } else if (data.status === 'skipped') {
                // å·²å­˜åœ¨ä¸”å·²å¤„ç†ï¼šåç«¯èŠ‚æµæ¨é€ï¼Œé¿å…ç”¨æˆ·è¯¯ä»¥ä¸ºå¡ä½
                logContainer.append(`<div class="text-muted">â†ªï¸ ${data.message}</div>`);
                
            } else if (data.status === 'reanalyzing') {
                logContainer.append(`<div class="text-info">ğŸ”„ ${data.message}</div>`);
            } else if (data.status === 'reanalyzed') {
                analyzedCount++;
                
                // reanalyzed æ˜¯é’ˆå¯¹å·²å­˜åœ¨çš„é‚®ä»¶ï¼Œéœ€è¦æ›´æ–° existingEmails
                const existingIndex = existingEmails.findIndex(email => email.id === data.email_id);
                if (existingIndex !== -1) {
                    existingEmails[existingIndex].summary = data.analysis?.summary || 'åˆ†æå®Œæˆ';
                    existingEmails[existingIndex].is_processed = true;
                    existingEmails[existingIndex].events = data.analysis?.events || [];
                    
                    // å¤„ç†é‡è¦æ€§çº§åˆ«
                    let importanceScore = data.analysis?.importance_score || 5;
                    if (importanceScore >= 8) existingEmails[existingIndex].importance_level = 'important';
                    else if (importanceScore >= 4) existingEmails[existingIndex].importance_level = 'normal';
                    else existingEmails[existingIndex].importance_level = 'unimportant';
                } else {
                    // è¯¥é‚®ä»¶ä¸åœ¨å½“å‰é¡µé¢åˆ—è¡¨ä¸­ï¼šåˆ›å»ºå ä½å¹¶æ’å…¥ï¼Œä¿è¯æµå¼åˆ—è¡¨æŒç»­æ›´æ–°
                    existingEmails.push({
                        id: data.email_id,
                        subject: data.subject || '(æ— ä¸»é¢˜)',
                        sender: data.sender || '',
                        received_date: data.received_date || new Date().toISOString(),
                        importance_level: 'normal',
                        summary: data.analysis?.summary || 'åˆ†æå®Œæˆ',
                        is_processed: true,
                        events: data.analysis?.events || []
                    });
                }
                
                // ä¹Ÿæ£€æŸ¥ savedEmailsï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
                const savedIndex = savedEmails.findIndex(email => email.id === data.email_id);
                if (savedIndex !== -1) {
                    savedEmails[savedIndex].summary = data.analysis?.summary || 'åˆ†æå®Œæˆ';
                    savedEmails[savedIndex].is_processed = true;
                    savedEmails[savedIndex].events = data.analysis?.events || [];
                    
                    let importanceScore = data.analysis?.importance_score || 5;
                    if (importanceScore >= 8) savedEmails[savedIndex].importance_level = 'important';
                    else if (importanceScore >= 4) savedEmails[savedIndex].importance_level = 'normal';
                    else savedEmails[savedIndex].importance_level = 'unimportant';
                }
                
                logContainer.append(`<div class="text-success">âœ… ${data.message}</div>`);
                
                // å®æ—¶æ›´æ–°é‚®ä»¶åˆ—è¡¨
                updateEmailList();
                
            } else if (data.status === 'analyzing') {
                logContainer.append(`<div class="text-info">ğŸ¤– ${data.message}</div>`);
            } else if (data.status === 'analyzed') {
                analyzedCount++;
                
                // æ›´æ–°å·²ä¿å­˜é‚®ä»¶ä¸­çš„åˆ†æç»“æœ
                const emailIndex = savedEmails.findIndex(email => email.id === data.email_id);
                if (emailIndex !== -1) {
                    savedEmails[emailIndex].summary = data.analysis?.summary || 'åˆ†æå®Œæˆ';
                    savedEmails[emailIndex].is_processed = true;
                    savedEmails[emailIndex].events = data.analysis?.events || [];
                    
                    // å¤„ç†é‡è¦æ€§çº§åˆ«
                    let importanceScore = data.analysis?.importance_score || 5;
                    if (importanceScore >= 8) savedEmails[emailIndex].importance_level = 'important';
                    else if (importanceScore >= 4) savedEmails[emailIndex].importance_level = 'normal';
                    else savedEmails[emailIndex].importance_level = 'unimportant';
                }
                
                logContainer.append(`<div class="text-success">ğŸ¯ ${data.message}</div>`);
                
                // å®æ—¶æ›´æ–°é‚®ä»¶åˆ—è¡¨
                updateEmailList();
                
            } else if (data.status === 'progress') {
                // æ›´æ–°è¿›åº¦æ¡
                updateStreamingStats(data.processed, data.total, data.saved, data.analyzed);
                logContainer.append(`<div class="text-primary">ğŸ“Š ${data.message}</div>`);
                
                    } else if (data.status === 'completed') {
                        logContainer.append(`<div class="text-success fw-bold">âœ… ${data.message}</div>`);
                        logContainer.append(`<div class="text-info">ğŸ“Š æœ€ç»ˆç»Ÿè®¡: å¤„ç† ${processedCount} å°ï¼Œä¿å­˜ ${savedCount} å°ï¼Œåˆ†æ ${analyzedCount} å°</div>`);
                        
                        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        updateStreamingStats(savedCount, savedCount, savedCount, analyzedCount);
                        
                        // å…³é—­EventSource
                        eventSource.close();
                        
                        // å»¶è¿Ÿåˆ·æ–°é‚®ä»¶åˆ—è¡¨
                        setTimeout(() => {
                            // æ¸…é™¤æµå¼å¤„ç†çŠ¶æ€
                            streamingInProgress = false;
                            // ç§»é™¤æµå¼å¤„ç†è¿›åº¦æ¡
                            $('#streaming-progress').remove();
                            // é‡æ–°åŠ è½½é‚®ä»¶åˆ—è¡¨
                            loadEmails();
                            // å®Œæˆåæ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
                            logContainer.scrollTop(logContainer[0].scrollHeight);
                        }, 1000);
                
            } else if (data.status === 'cancelled') {
                logContainer.append(`<div class="text-warning fw-bold">â¹ï¸ ${data.message || 'å·²ç»ˆæ­¢æµå¼å¤„ç†'}</div>`);
                try { eventSource.close(); } catch (_) {}
                streamingInProgress = false;
                // ç»ˆæ­¢ååˆ·æ–°é‚®ä»¶åˆ—è¡¨
                setTimeout(() => loadEmails(), 500);
                
            } else if (data.status === 'error') {
                // å•å°é‚®ä»¶é”™è¯¯ä¸åº”ç»ˆæ­¢ï¼›åªæœ‰ fatal é”™è¯¯æ‰ç»ˆæ­¢
                const isFatal = !!data.fatal;
                logContainer.append(`<div class="text-danger">âŒ ${data.message}${isFatal ? 'ï¼ˆè‡´å‘½é”™è¯¯ï¼‰' : ''}</div>`);
                if (isFatal) {
                eventSource.close();
                streamingInProgress = false;
                }
            }
            
                // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—ï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨æ»šåŠ¨ï¼‰
                const logElement = logContainer[0];
                const isAtBottom = logElement.scrollTop + logElement.clientHeight >= logElement.scrollHeight - 10;
                if (isAtBottom) {
                    logContainer.scrollTop(logContainer[0].scrollHeight);
                }
            
        } catch (e) {
            console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e);
            logContainer.append(`<div class="text-danger">âŒ æ•°æ®è§£æå¤±è´¥: ${e.message}</div>`);
        }
    };
    
    eventSource.onerror = function(event) {
        console.error('EventSourceé”™è¯¯:', event);
        console.error('EventSourceçŠ¶æ€:', eventSource.readyState);
        logContainer.append(`<div class="text-danger">âŒ æµå¼è¿æ¥é”™è¯¯ (çŠ¶æ€: ${eventSource.readyState})</div>`);
        
        // è®©æµè§ˆå™¨å†…ç½®çš„ SSE é‡è¿æœºåˆ¶å¤„ç†ï¼›æ‰‹åŠ¨ new EventSource å®¹æ˜“é€ æˆå¤šè¿æ¥å¹¶å‘ã€é‡å¤æ‰“å°/é‡å¤æ¸²æŸ“
        // å¦‚é‡åˆ°è‡´å‘½é”™è¯¯ï¼Œåç«¯ä¼šå‘é€ fatal error å¹¶ç”± onmessage å…³é—­è¿æ¥
        };
    }

    // å¯åŠ¨ï¼šå…ˆåŠ è½½åŸºå‡†åˆ—è¡¨ï¼Œå†è¿ SSEï¼ˆä¿è¯æ–°é‚®ä»¶ä¸€å®šæ’åœ¨æœ€å‰ï¼‰
    loadBaselineAndStart();
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStreamingStats(processed = 0, total = 0, saved = 0, analyzed = 0) {
        $('#streaming-stats').text(`å·²å¤„ç† ${processed} ä¸ªé‚®ä»¶ï¼Œå…± ${total} ä¸ªé‚®ä»¶`);
    }
    
    // å®æ—¶æ›´æ–°é‚®ä»¶åˆ—è¡¨
    function updateEmailList() {
        // åˆå¹¶é‚®ä»¶ï¼šæ–°é‚®ä»¶åœ¨å‰ï¼Œç°æœ‰é‚®ä»¶åœ¨å
        const allEmails = [...savedEmails, ...existingEmails];
        
        // å»é‡ï¼ˆåŸºäºé‚®ä»¶IDï¼Œä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„ï¼Œå³savedEmailsä¸­çš„ä¼˜å…ˆï¼‰
        const uniqueEmails = [];
        const seenIds = new Set();
        allEmails.forEach(email => {
            if (!seenIds.has(email.id)) {
                seenIds.add(email.id);
                uniqueEmails.push(email);
            }
        });
        
        if (uniqueEmails.length === 0) return;
        
        // æŒ‰æ¥æ”¶æ—¶é—´é™åºæ’åˆ—ï¼ˆæ–°é‚®ä»¶åœ¨ä¸Šï¼‰
        uniqueEmails.sort(function(a, b) {
            const dateA = new Date(a.received_date);
            const dateB = new Date(b.received_date);
            return dateB - dateA;
        });
        
        // å¤ç”¨ç»Ÿä¸€æ¸²æŸ“ï¼Œé¿å… DOM ç»“æ„ä¸ä¸€è‡´å¯¼è‡´ä¸‹ä¸€æ¬¡è§£æé”™ä½
        displayEmails(uniqueEmails);
        $('#email-count').text(`${uniqueEmails.length} å°é‚®ä»¶`);
    }
}

// ç»ˆæ­¢æµå¼å¤„ç†
async function stopEmailsStream() {
    try {
        const resp = await fetch('/api/emails/stop-stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await resp.json();
        console.log('stop-stream:', data);
        // ç«‹å³å…³é—­å‰ç«¯ SSEï¼Œé¿å…ç»§ç»­åˆ·æ—¥å¿—
        try { if (currentEventSource) currentEventSource.close(); } catch (_) {}
        if (data && data.success && data.stopped) {
            $('#streaming-log').append(`<div class="text-warning">â¹ï¸ å·²å‘é€ç»ˆæ­¢è¯·æ±‚</div>`);
        } else {
            $('#streaming-log').append(`<div class="text-warning">âš ï¸ ${data?.message || data?.error || 'å½“å‰æ²¡æœ‰è¿è¡Œä¸­çš„æµå¼ä»»åŠ¡'}</div>`);
        }
    } catch (e) {
        console.error('stopEmailsStream failed:', e);
        $('#streaming-log').append(`<div class="text-danger">âŒ ç»ˆæ­¢å¤±è´¥: ${e.message}</div>`);
    }
}

// å¤„ç†æµå¼æ•°æ®
function handleStreamingData(data, logContainer) {
    const timestamp = new Date().toLocaleTimeString();
    let message = '';
    let className = 'text-muted';
    
    switch (data.status) {
        case 'started':
            message = `ğŸš€ ${data.message}`;
            className = 'text-primary';
            break;
        case 'saving':
            message = `ğŸ’¾ ${data.message}`;
            className = 'text-warning';
            break;
        case 'saved':
            message = `âœ… ${data.message}`;
            className = 'text-success';
            break;
        case 'analyzing':
            message = `ğŸ¤– ${data.message}`;
            className = 'text-info';
            break;
        case 'analyzed':
            message = `ğŸ¯ ${data.message}`;
            className = 'text-success';
            if (data.analysis) {
                message += ` (é‡è¦æ€§: ${data.analysis.importance || 'N/A'})`;
            }
            break;
        case 'reanalyzing':
            message = `ğŸ”„ ${data.message}`;
            className = 'text-warning';
            break;
        case 'analysis_failed':
            message = `âŒ ${data.message}`;
            className = 'text-danger';
            break;
        case 'error':
            message = `âŒ ${data.message}`;
            className = 'text-danger';
            break;
        case 'completed':
            message = `ğŸ‰ ${data.message}`;
            className = 'text-success';
            break;
        default:
            message = `â„¹ï¸ ${data.message || 'æœªçŸ¥çŠ¶æ€'}`;
            className = 'text-muted';
    }
    
    logContainer.append(`<div class="${className}">[${timestamp}] ${message}</div>`);
    logContainer.scrollTop(logContainer[0].scrollHeight);
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    updateStreamingStats();
}

// æ›´æ–°æµå¼å¤„ç†ç»Ÿè®¡ä¿¡æ¯
function updateStreamingStats() {
    const logContainer = $('#streaming-log');
    const logs = logContainer.find('div');
    let savedCount = 0;
    let analyzedCount = 0;
    let errorCount = 0;
    
    logs.each(function() {
        const text = $(this).text();
        if (text.includes('âœ…') && text.includes('é‚®ä»¶å·²ä¿å­˜')) {
            savedCount++;
        } else if (text.includes('ğŸ¯') && text.includes('åˆ†æå®Œæˆ')) {
            analyzedCount++;
        } else if (text.includes('âŒ')) {
            errorCount++;
        }
    });
    
    const statsText = `å·²ä¿å­˜: ${savedCount} | å·²åˆ†æ: ${analyzedCount} | é”™è¯¯: ${errorCount}`;
    $('#streaming-stats').text(statsText);
}

function reanalyzeAllEmails() {
     if (!confirm('ç¡®å®šè¦é‡æ–°åˆ†ææ‰€æœ‰é‚®ä»¶å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
         return;
     }
     
     showMessage('æ­£åœ¨é‡æ–°åˆ†ææ‰€æœ‰é‚®ä»¶...', 'info');
     
     $.post('/api/emails/reanalyze_all', { max_count: getMaxSyncCount() }, function(data) {
         if (data.success) {
             showMessage(data.message, 'success');
             refreshEmails();
         } else {
             showMessage('é‡æ–°åˆ†æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
         }
     }).fail(function() {
         showMessage('ç½‘ç»œè¯·æ±‚å¤±è´¥', 'danger');
     });
 }
 
 function retryAnalysis(emailId) {
     if (!confirm('ç¡®å®šè¦é‡è¯•åˆ†æè¿™å°é‚®ä»¶å—ï¼Ÿè¿™å°†ä½¿ç”¨å¢å¼ºçš„è°ƒè¯•æ¨¡å¼ã€‚')) {
         return;
     }
     
     showMessage('æ­£åœ¨é‡è¯•åˆ†æé‚®ä»¶ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰...', 'info');
     
     $.ajax({
         url: `/api/email/${emailId}/retry-analysis`,
         method: 'POST',
         contentType: 'application/json',
         data: JSON.stringify({ debug: true }),
         success: function(data) {
             if (data.success) {
                 showMessage('é‚®ä»¶é‡è¯•åˆ†æå®Œæˆ', 'success');
                 loadEmails(); // åˆ·æ–°é‚®ä»¶åˆ—è¡¨
             } else {
                 showMessage('é‡è¯•åˆ†æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
                 if (data.debug_info) {
                     console.log('è°ƒè¯•ä¿¡æ¯:', data.debug_info);
                 }
             }
         },
         error: function(xhr, status, error) {
             showMessage('é‡è¯•åˆ†æè¯·æ±‚å¤±è´¥: ' + error, 'danger');
         }
     });
 }
 
 function reanalyzeEmail(emailId) {
     if (!confirm('ç¡®å®šè¦é‡æ–°åˆ†æè¿™å°é‚®ä»¶å—ï¼Ÿ')) {
         return;
     }
     
     showMessage('æ­£åœ¨é‡æ–°åˆ†æé‚®ä»¶...', 'info');
     
     $.post(`/api/email/${emailId}/reanalyze`, function(data) {
         if (data.success) {
             showMessage('é‚®ä»¶é‡æ–°åˆ†æå®Œæˆ', 'success');
             refreshEmails();
         } else {
             showMessage('é‡æ–°åˆ†æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
         }
     }).fail(function() {
         showMessage('ç½‘ç»œè¯·æ±‚å¤±è´¥', 'danger');
     });
 }
 
 function updateSelectedCount() {
     const selectedCount = $('.email-checkbox:checked').length;
     $('#selected-count').text(selectedCount);
 }
 
 function syncAllToNotion() {
     if (!confirm('ç¡®å®šè¦å°†å½“å‰é¡µé¢çš„æ‰€æœ‰é‚®ä»¶åŒæ­¥åˆ°Notionå—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
         return;
     }
     
     const emailIds = [];
     $('.email-checkbox').each(function() {
         emailIds.push(parseInt($(this).val()));
     });
     
     if (emailIds.length === 0) {
         showMessage('æ²¡æœ‰å¯åŒæ­¥çš„é‚®ä»¶', 'warning');
         return;
     }
     
     syncEmailsToNotion(emailIds, 'ä¸€é”®åŒæ­¥');
 }
 
 function syncSelectedToNotion() {
     const selectedIds = [];
     $('.email-checkbox:checked').each(function() {
         selectedIds.push(parseInt($(this).val()));
     });
     
     if (selectedIds.length === 0) {
         showMessage('è¯·å…ˆé€‰æ‹©è¦åŒæ­¥çš„é‚®ä»¶', 'warning');
         return;
     }
     
     if (!confirm(`ç¡®å®šè¦å°†é€‰ä¸­çš„ ${selectedIds.length} å°é‚®ä»¶åŒæ­¥åˆ°Notionå—ï¼Ÿ`)) {
         return;
     }
     
     syncEmailsToNotion(selectedIds, 'é€‰ä¸­åŒæ­¥');
 }
 
 function syncEmailsToNotion(emailIds, syncType) {
     showMessage(`æ­£åœ¨${syncType}åˆ°Notionï¼Œè¯·ç¨å€™...`, 'info');
     
     let successCount = 0;
     let failCount = 0;
     let processedCount = 0;
     
     // æ‰¹é‡åŒæ­¥é‚®ä»¶
     emailIds.forEach(function(emailId, index) {
         setTimeout(function() {
             $.ajax({
                 url: `/api/notion/archive/${emailId}`,
                 method: 'POST',
                 success: function(data) {
                     processedCount++;
                     if (data.success) {
                         successCount++;
                     } else {
                         failCount++;
                     }
                     
                     // æ›´æ–°è¿›åº¦
                     const progress = Math.round((processedCount / emailIds.length) * 100);
                     showMessage(`${syncType}è¿›åº¦: ${progress}% (${processedCount}/${emailIds.length})`, 'info');
                     
                     // æ‰€æœ‰é‚®ä»¶å¤„ç†å®Œæˆ
                     if (processedCount === emailIds.length) {
                         const message = `${syncType}å®Œæˆï¼æˆåŠŸ: ${successCount} å°ï¼Œå¤±è´¥: ${failCount} å°`;
                         showMessage(message, failCount > 0 ? 'warning' : 'success');
                         
                         // åˆ·æ–°é‚®ä»¶åˆ—è¡¨
                         loadEmails();
                     }
                 },
                 error: function() {
                     processedCount++;
                     failCount++;
                     
                     // æ›´æ–°è¿›åº¦
                     const progress = Math.round((processedCount / emailIds.length) * 100);
                     showMessage(`${syncType}è¿›åº¦: ${progress}% (${processedCount}/${emailIds.length})`, 'info');
                     
                     // æ‰€æœ‰é‚®ä»¶å¤„ç†å®Œæˆ
                     if (processedCount === emailIds.length) {
                         const message = `${syncType}å®Œæˆï¼æˆåŠŸ: ${successCount} å°ï¼Œå¤±è´¥: ${failCount} å°`;
                         showMessage(message, failCount > 0 ? 'warning' : 'success');
                         
                         // åˆ·æ–°é‚®ä»¶åˆ—è¡¨
                         loadEmails();
                     }
                 }
             });
         }, index * 500); // æ¯500mså¤„ç†ä¸€ä¸ªé‚®ä»¶ï¼Œé¿å…APIé™åˆ¶
      });
  }
  
  function showImageModal(uniqueFilename, originalFilename) {
      const imageUrl = `/attachments/${uniqueFilename}`;
      $('#imageModalImg').attr('src', imageUrl).attr('alt', originalFilename);
      $('#imageModalTitle').text(originalFilename);
      $('#imageDownloadBtn').attr('href', imageUrl).attr('download', originalFilename);
      $('#imageModal').modal('show');
  }
  
  function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  </script>
  <script>
  // åˆ‡æ¢æµå¼æ—¥å¿—å±•å¼€/æŠ˜å 
  function toggleStreamingLog() {
      const logContainer = $('#streaming-log-container');
      const toggleIcon = $('#streaming-toggle-icon');
      
      if (logContainer.is(':visible')) {
          logContainer.slideUp(300);
          toggleIcon.removeClass('fa-compress-alt').addClass('fa-expand-alt');
      } else {
          logContainer.slideDown(300);
          toggleIcon.removeClass('fa-expand-alt').addClass('fa-compress-alt');
      }
  }

  function getMaxSyncCount() {
      const val = parseInt(document.getElementById('max-sync-count').value || '');
      return Number.isFinite(val) && val > 0 ? val : undefined;
  }
  </script>
  {% endblock %}