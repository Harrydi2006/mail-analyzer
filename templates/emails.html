{% extends "base.html" %}

{% block title %}邮件管理 - 邮件智能日程管理系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 页面标题和操作按钮 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-inbox me-2"></i>
                邮件管理
            </h2>
            <div>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" onclick="checkEmail()">
                        <i class="fas fa-sync-alt me-1"></i>
                        检查新邮件
                    </button>
                    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                        <span class="visually-hidden">切换下拉菜单</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="reanalyzeAllEmails()"><i class="fas fa-robot me-2"></i>重新分析所有邮件</a></li>
                    </ul>
                </div>
                <button class="btn btn-outline-secondary" onclick="refreshEmails()">
                    <i class="fas fa-refresh me-1"></i>
                    刷新列表
                </button>
            </div>
        </div>
        
        <!-- 筛选和搜索 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">重要性筛选</label>
                        <select class="form-select" id="importance-filter">
                            <option value="">全部</option>
                            <option value="important">重要</option>
                            <option value="normal">普通</option>
                            <option value="unimportant">不重要</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">处理状态</label>
                        <select class="form-select" id="status-filter">
                            <option value="">全部</option>
                            <option value="processed">已处理</option>
                            <option value="unprocessed">未处理</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">显示数量</label>
                        <select class="form-select" id="limit-select" onchange="changeLimit()">
                            <option value="50">50封</option>
                            <option value="100">100封</option>
                            <option value="200" selected>200封</option>
                            <option value="500">500封</option>
                            <option value="1000">全部</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">搜索</label>
                        <input type="text" class="form-control" id="search-input" placeholder="搜索邮件主题或发件人...">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-primary d-block w-100" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>
                            搜索
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-info" onclick="syncAllToNotion()">
                                <i class="fas fa-sync me-1"></i>
                                一键同步到Notion
                            </button>
                            <button class="btn btn-outline-info" onclick="syncSelectedToNotion()">
                                <i class="fas fa-check-square me-1"></i>
                                同步选中邮件
                            </button>
                            <div class="ms-auto">
                                <small class="text-muted">已选中 <span id="selected-count">0</span> 封邮件</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 邮件列表 -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">邮件列表</h5>
                    <span class="badge bg-secondary" id="email-count">0 封邮件</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="emails-container">
                    <div class="text-center p-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">加载邮件列表中...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分页 -->
        <nav aria-label="邮件分页" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分页按钮将通过JavaScript动态生成 -->
            </ul>
        </nav>
    </div>
</div>

<!-- 邮件详情模态框 -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailModalTitle">邮件详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="emailModalBody">
                <!-- 邮件详情内容将通过JavaScript动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="viewNotionBtn" style="display: none;">
                    <i class="fas fa-external-link-alt me-1"></i>
                    查看Notion页面
                </button>
                <button type="button" class="btn btn-info" id="archiveNotionBtn" style="display: none;">
                    <i class="fas fa-archive me-1"></i>
                    归档到Notion
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 图片查看模态框 -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">图片查看</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imageModalImg" src="" alt="" class="img-fluid" style="max-height: 70vh;">
            </div>
            <div class="modal-footer">
                <a id="imageDownloadBtn" href="" class="btn btn-primary" download="">
                    <i class="fas fa-download me-1"></i>下载图片
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};

$(document).ready(function() {
    // 从URL参数设置显示数量
    const urlParams = new URLSearchParams(window.location.search);
    const limit = urlParams.get('limit') || '200';
    $('#limit-select').val(limit);
    
    loadEmails();
    
    // 搜索框回车事件
    $('#search-input').on('keypress', function(e) {
        if (e.which === 13) {
            applyFilters();
        }
    });
});

function loadEmails(page = 1) {
    currentPage = page;
    
    // 获取当前选择的显示数量
    const limit = $('#limit-select').val() || '200';
    
    const params = {
        page: page,
        limit: limit,
        ...currentFilters
    };
    
    $('#emails-container').html(`
        <div class="text-center p-4">
            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="text-muted mt-2">加载邮件列表中...</p>
        </div>
    `);
    
    $.get('/api/emails', params, function(data) {
        if (data.success) {
            displayEmails(data.emails);
            updatePagination(data.total, data.page, data.per_page);
            $('#email-count').text(`${data.total} 封邮件`);
        } else {
            $('#emails-container').html(`
                <div class="text-center p-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    <p class="text-muted mt-2">加载失败: ${data.error || '未知错误'}</p>
                </div>
            `);
        }
    }).fail(function() {
        $('#emails-container').html(`
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                <p class="text-muted mt-2">网络请求失败</p>
            </div>
        `);
    });
}

function displayEmails(emails) {
    if (emails.length === 0) {
        $('#emails-container').html(`
            <div class="text-center p-4">
                <i class="fas fa-inbox fa-2x text-muted"></i>
                <p class="text-muted mt-2">暂无邮件数据</p>
            </div>
        `);
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    emails.forEach(function(email) {
        const importanceClass = getImportanceClass(email.importance_level);
        const importanceText = getImportanceText(email.importance_level);
        const receivedDate = new Date(email.received_date).toLocaleString();
        const processedStatus = email.is_processed ? '已处理' : '未处理';
        const processedClass = email.is_processed ? 'success' : 'warning';
        const eventsCount = email.events ? email.events.length : 0;
        
        html += `
            <div class="list-group-item list-group-item-action" id="email-${email.id}">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="form-check me-3">
                        <input class="form-check-input email-checkbox" type="checkbox" value="${email.id}" onchange="updateSelectedCount()">
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge ${importanceClass} me-2">${importanceText}</span>
                            <span class="badge bg-${processedClass} me-2">${processedStatus}</span>
                            ${eventsCount > 0 ? `<span class="badge bg-info me-2">${eventsCount} 个事件</span>` : ''}
                        </div>
                        <h6 class="mb-1">${email.subject || '无主题'}</h6>
                        <p class="mb-1 text-muted">${email.summary || '暂无AI总结'}</p>
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>${email.sender}
                            <i class="fas fa-clock ms-3 me-1"></i>${receivedDate}
                        </small>
                    </div>
                    <div class="text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewEmail(${email.id})">
                                <i class="fas fa-eye me-1"></i>查看
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="reanalyzeEmail(${email.id})" title="重新分析">
                                <i class="fas fa-robot"></i>
                            </button>
                            ${(!email.summary || email.summary === '邮件内容分析失败' || email.summary === 'AI分析失败') ? 
                                `<button class="btn btn-sm btn-warning" onclick="retryAnalysis(${email.id})" title="分析失败，点击重试">
                                    <i class="fas fa-redo me-1"></i>重试
                                </button>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    $('#emails-container').html(html);
}

function viewEmail(emailId) {
    $('#emailModalBody').html(`
        <div class="text-center p-4">
            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="text-muted mt-2">加载邮件详情中...</p>
        </div>
    `);
    
    $('#emailModal').modal('show');
    
    $.get(`/api/email/${emailId}`, function(data) {
        if (data.id) {
            displayEmailDetails(data);
        } else {
            $('#emailModalBody').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || '邮件不存在'}
                </div>
            `);
        }
    }).fail(function() {
        $('#emailModalBody').html(`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                网络请求失败
            </div>
        `);
    });
}

function displayEmailDetails(email) {
    const importanceClass = getImportanceClass(email.importance_level);
    const importanceText = getImportanceText(email.importance_level);
    const receivedDate = new Date(email.received_date).toLocaleString();
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>发件人:</strong> ${email.sender}
            </div>
            <div class="col-md-6">
                <strong>收件时间:</strong> ${receivedDate}
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>重要性:</strong> 
                <span class="badge ${importanceClass}">${importanceText}</span>
            </div>
            <div class="col-md-6">
                <strong>处理状态:</strong> 
                <span class="badge ${email.is_processed ? 'bg-success' : 'bg-warning'}">
                    ${email.is_processed ? '已处理' : '未处理'}
                </span>
            </div>
        </div>
    `;
    
    // AI分析结果
    if (email.summary) {
        html += `
            <div class="mb-3">
                <h6><i class="fas fa-robot me-2"></i>AI总结</h6>
                <div class="alert alert-info">
                    ${email.summary}
                </div>
            </div>
        `;
    }
    
    // 提取的事件
    if (email.events && email.events.length > 0) {
        html += `
            <div class="mb-3">
                <h6><i class="fas fa-calendar-alt me-2"></i>提取的事件 (${email.events.length})</h6>
        `;
        
        email.events.forEach(function(event, index) {
            const eventImportanceClass = getImportanceClass(event.importance_level);
            const startTime = new Date(event.start_time).toLocaleString();
            
            html += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    <span class="badge ${eventImportanceClass} me-2">${getImportanceText(event.importance_level)}</span>
                                    ${event.title}
                                </h6>
                                <p class="mb-1 small text-dark">${event.description || '无描述'}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>${startTime}
                                    ${event.location ? `<i class="fas fa-map-marker-alt ms-2 me-1"></i>${event.location}` : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // 邮件附件和图片
    if (email.images && email.images.length > 0) {
        html += `
            <div class="mb-3">
                <h6><i class="fas fa-image me-2"></i>邮件图片 (${email.images.length})</h6>
                <div class="row">
        `;
        
        email.images.forEach(function(image, index) {
            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <img src="/attachments/${image.unique_filename}" class="card-img-top" alt="${image.filename}" style="height: 200px; object-fit: cover; cursor: pointer;" onclick="showImageModal('${image.unique_filename}', '${image.filename}')">
                        <div class="card-body p-2">
                            <small class="text-muted">
                                <i class="fas fa-file-image me-1"></i>${image.filename}
                                <br><i class="fas fa-weight me-1"></i>${formatFileSize(image.size || 0)}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // 其他附件
    if (email.attachments && email.attachments.length > 0) {
        html += `
            <div class="mb-3">
                <h6><i class="fas fa-paperclip me-2"></i>附件 (${email.attachments.length})</h6>
        `;
        
        email.attachments.forEach(function(attachment, index) {
            html += `
                <div class="d-flex align-items-center mb-2 p-2 border rounded">
                    <i class="fas fa-file me-2 text-muted"></i>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${attachment.filename}</div>
                        <small class="text-muted">${formatFileSize(attachment.size || 0)}</small>
                    </div>
                    <a href="/attachments/${attachment.unique_filename}" class="btn btn-sm btn-outline-primary" download="${attachment.filename}">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // 邮件原文
    html += `
        <div class="mb-3">
            <h6><i class="fas fa-envelope me-2"></i>邮件原文</h6>
            <div class="border rounded p-3 email-content-area" style="max-height: 300px; overflow-y: auto;">
                <pre class="mb-0 email-content-text" style="white-space: pre-wrap; font-size: 0.9em;">${email.content || '无内容'}</pre>
            </div>
        </div>
    `;
    
    $('#emailModalTitle').text(email.subject || '无主题');
    $('#emailModalBody').html(html);
    
    // 设置Notion按钮
    if (email.notion_url) {
        // 如果已经归档到Notion，显示查看按钮
        $('#viewNotionBtn').show().off('click').on('click', function() {
            window.open(email.notion_url, '_blank');
        });
        $('#archiveNotionBtn').hide();
    } else {
        // 如果未归档，显示归档按钮
        $('#viewNotionBtn').hide();
        $('#archiveNotionBtn').show().off('click').on('click', function() {
            archiveEmailToNotion(email.id);
        });
    }
}

function archiveEmailToNotion(emailId) {
    if (!confirm('确定要将此邮件归档到Notion吗？')) {
        return;
    }
    
    showMessage('正在归档到Notion...', 'info');
    
    $.ajax({
        url: `/api/notion/archive/${emailId}`,
        method: 'POST',
        success: function(data) {
            if (data.success) {
                showMessage('邮件归档成功！', 'success');
                // 刷新邮件详情
                viewEmail(emailId);
            } else {
                showMessage('归档失败: ' + (data.error || '未知错误'), 'danger');
            }
        },
        error: function(xhr, status, error) {
            showMessage('归档请求失败: ' + error, 'danger');
        }
    });
}
 
 function applyFilters() {
    currentFilters = {
        importance: $('#importance-filter').val(),
        status: $('#status-filter').val(),
        search: $('#search-input').val().trim()
    };
    
    loadEmails(1);
}

function refreshEmails() {
    loadEmails(currentPage);
}

function updatePagination(total, page, perPage) {
    totalPages = Math.ceil(total / perPage);
    currentPage = page;
    
    let html = '';
    
    // 上一页
    if (currentPage > 1) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadEmails(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
    }
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadEmails(1)">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadEmails(${i})">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadEmails(${totalPages})">${totalPages}</a></li>`;
    }
    
    // 下一页
    if (currentPage < totalPages) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadEmails(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
    }
    
    $('#pagination').html(html);
}

function getImportanceClass(level) {
    switch(level) {
        case 'important': return 'bg-danger';
        case 'normal': return 'bg-primary';
        case 'unimportant': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

function getImportanceText(level) {
    switch(level) {
        case 'important': return '重要';
        case 'normal': return '普通';
        case 'unimportant': return '不重要';
        default: return '未知';
    }
}

function changeLimit() {
    const limit = $('#limit-select').val();
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('limit', limit);
    window.location.href = currentUrl.toString();
}

function checkEmail() {
    showMessage('正在检查新邮件...', 'info');
    
    $.ajax({
        url: '/api/check_email',
        method: 'POST',
        contentType: 'application/json',
        success: function(data) {
            if (data.success) {
                showMessage(data.message, 'success');
                refreshEmails(); // 刷新邮件列表
            } else {
                showMessage('检查邮件失败: ' + (data.error || '未知错误'), 'danger');
            }
        },
        error: function(xhr, status, error) {
            showMessage('检查邮件请求失败: ' + error, 'danger');
        }
    });
}

function reanalyzeAllEmails() {
     if (!confirm('确定要重新分析所有邮件吗？这可能需要一些时间。')) {
         return;
     }
     
     showMessage('正在重新分析所有邮件...', 'info');
     
     $.post('/api/emails/reanalyze_all', function(data) {
         if (data.success) {
             showMessage(data.message, 'success');
             refreshEmails();
         } else {
             showMessage('重新分析失败: ' + (data.error || '未知错误'), 'danger');
         }
     }).fail(function() {
         showMessage('网络请求失败', 'danger');
     });
 }
 
 function retryAnalysis(emailId) {
     if (!confirm('确定要重试分析这封邮件吗？这将使用增强的调试模式。')) {
         return;
     }
     
     showMessage('正在重试分析邮件（调试模式）...', 'info');
     
     $.ajax({
         url: `/api/email/${emailId}/retry-analysis`,
         method: 'POST',
         contentType: 'application/json',
         data: JSON.stringify({ debug: true }),
         success: function(data) {
             if (data.success) {
                 showMessage('邮件重试分析完成', 'success');
                 loadEmails(); // 刷新邮件列表
             } else {
                 showMessage('重试分析失败: ' + (data.error || '未知错误'), 'danger');
                 if (data.debug_info) {
                     console.log('调试信息:', data.debug_info);
                 }
             }
         },
         error: function(xhr, status, error) {
             showMessage('重试分析请求失败: ' + error, 'danger');
         }
     });
 }
 
 function reanalyzeEmail(emailId) {
     if (!confirm('确定要重新分析这封邮件吗？')) {
         return;
     }
     
     showMessage('正在重新分析邮件...', 'info');
     
     $.post(`/api/email/${emailId}/reanalyze`, function(data) {
         if (data.success) {
             showMessage('邮件重新分析完成', 'success');
             refreshEmails();
         } else {
             showMessage('重新分析失败: ' + (data.error || '未知错误'), 'danger');
         }
     }).fail(function() {
         showMessage('网络请求失败', 'danger');
     });
 }
 
 function updateSelectedCount() {
     const selectedCount = $('.email-checkbox:checked').length;
     $('#selected-count').text(selectedCount);
 }
 
 function syncAllToNotion() {
     if (!confirm('确定要将当前页面的所有邮件同步到Notion吗？这可能需要一些时间。')) {
         return;
     }
     
     const emailIds = [];
     $('.email-checkbox').each(function() {
         emailIds.push(parseInt($(this).val()));
     });
     
     if (emailIds.length === 0) {
         showMessage('没有可同步的邮件', 'warning');
         return;
     }
     
     syncEmailsToNotion(emailIds, '一键同步');
 }
 
 function syncSelectedToNotion() {
     const selectedIds = [];
     $('.email-checkbox:checked').each(function() {
         selectedIds.push(parseInt($(this).val()));
     });
     
     if (selectedIds.length === 0) {
         showMessage('请先选择要同步的邮件', 'warning');
         return;
     }
     
     if (!confirm(`确定要将选中的 ${selectedIds.length} 封邮件同步到Notion吗？`)) {
         return;
     }
     
     syncEmailsToNotion(selectedIds, '选中同步');
 }
 
 function syncEmailsToNotion(emailIds, syncType) {
     showMessage(`正在${syncType}到Notion，请稍候...`, 'info');
     
     let successCount = 0;
     let failCount = 0;
     let processedCount = 0;
     
     // 批量同步邮件
     emailIds.forEach(function(emailId, index) {
         setTimeout(function() {
             $.ajax({
                 url: `/api/notion/archive/${emailId}`,
                 method: 'POST',
                 success: function(data) {
                     processedCount++;
                     if (data.success) {
                         successCount++;
                     } else {
                         failCount++;
                     }
                     
                     // 更新进度
                     const progress = Math.round((processedCount / emailIds.length) * 100);
                     showMessage(`${syncType}进度: ${progress}% (${processedCount}/${emailIds.length})`, 'info');
                     
                     // 所有邮件处理完成
                     if (processedCount === emailIds.length) {
                         const message = `${syncType}完成！成功: ${successCount} 封，失败: ${failCount} 封`;
                         showMessage(message, failCount > 0 ? 'warning' : 'success');
                         
                         // 刷新邮件列表
                         loadEmails();
                     }
                 },
                 error: function() {
                     processedCount++;
                     failCount++;
                     
                     // 更新进度
                     const progress = Math.round((processedCount / emailIds.length) * 100);
                     showMessage(`${syncType}进度: ${progress}% (${processedCount}/${emailIds.length})`, 'info');
                     
                     // 所有邮件处理完成
                     if (processedCount === emailIds.length) {
                         const message = `${syncType}完成！成功: ${successCount} 封，失败: ${failCount} 封`;
                         showMessage(message, failCount > 0 ? 'warning' : 'success');
                         
                         // 刷新邮件列表
                         loadEmails();
                     }
                 }
             });
         }, index * 500); // 每500ms处理一个邮件，避免API限制
      });
  }
  
  function showImageModal(uniqueFilename, originalFilename) {
      const imageUrl = `/attachments/${uniqueFilename}`;
      $('#imageModalImg').attr('src', imageUrl).attr('alt', originalFilename);
      $('#imageModalTitle').text(originalFilename);
      $('#imageDownloadBtn').attr('href', imageUrl).attr('download', originalFilename);
      $('#imageModal').modal('show');
  }
  
  function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  </script>
  {% endblock %}